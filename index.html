<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Agendamento do Caminh√£o Munck</title>

    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        #calendario { max-height: 500px; margin-top: 20px; }
        .fc-event { cursor: pointer; }
        .fc-header-toolbar {
            margin-bottom: 0.5rem !important;
            font-size: 0.85rem;
        }
        .fc .fc-button { padding: 0.2rem 0.5rem !important; }
        .fc .fc-toolbar-title { font-size: 1.1rem !important; }
    </style>
</head>

<body class="bg-gray-100 p-4 md:p-8">
    <h1 class="text-3xl font-bold mb-8 text-center text-gray-800">üöó Agendamento do Caminh√£o Munck</h1>

    <div class="max-w-7xl mx-auto flex flex-col lg:flex-row gap-6 items-start">

        <div class="w-full lg:w-1/4 space-y-6">
            <div class="bg-white p-6 rounded-lg shadow-lg">
                <div id="login-section" class="text-center">
                    <h2 class="font-bold mb-4 text-gray-700">Acesso</h2>
                    <input type="email" id="email" placeholder="E-mail" class="w-full mb-2 p-2 border rounded text-sm text-center">
                    <input type="password" id="senha" placeholder="Senha" class="w-full mb-4 p-2 border rounded text-sm text-center">
                    <button onclick="fazerLogin()" class="w-full bg-blue-500 text-white p-2 rounded hover:bg-blue-600 transition font-bold mb-4">Entrar</button>
                    
                    <p class="text-xs text-gray-500">N√£o tem conta? 
                        <a href="javascript:void(0)" onclick="alternarTelas('login-section', 'register-section')" class="text-blue-600 hover:underline">Cadastre-se aqui</a>
                    </p>
                    <p class="text-xs text-gray-500">Deseja se tornar coordenador? 
                        <a href="javascript:void(0)" onclick="alternarTelas('login-section', 'register-manager-section')" class="text-blue-600 hover:underline">Cadastre-se como coordenador aqui</a>
                    </p>
                </div>
            
                <div id="register-section" class="hidden text-center">
                    <h2 class="font-bold mb-4 text-gray-700">Novo Cadastro</h2>
                    <input type="text" id="reg-nome" placeholder="Nome Completo" class="w-full mb-2 p-2 border rounded text-sm text-center">
                    <input type="email" id="reg-email" placeholder="E-mail" class="w-full mb-2 p-2 border rounded text-sm text-center">
                    <input type="password" id="reg-senha" placeholder="Crie uma Senha" class="w-full mb-4 p-2 border rounded text-sm text-center">
                    
                    <button onclick="fazerCadastro()" class="w-full bg-orange-500 text-white p-2 rounded hover:bg-orange-600 transition font-bold mb-4">Finalizar Cadastro</button>
                    
                    <p class="text-xs text-gray-500">J√° tem conta? 
                        <a href="javascript:void(0)" onclick="alternarTelas('register-section', 'login-section')" class="text-blue-600 hover:underline">Voltar ao Login</a>
                    </p>
                </div>

                <div id="register-manager-section" class="hidden text-center">
                    <h2 class="font-bold mb-4 text-gray-700">Novo Cadastro</h2>
                    <input type="text" id="reg-man-nome" placeholder="Nome Completo" class="w-full mb-2 p-2 border rounded text-sm text-center">
                    <input type="email" id="reg-man-email" placeholder="E-mail" class="w-full mb-2 p-2 border rounded text-sm text-center">
                    <input type="password" id="reg-man-senha" placeholder="Crie uma Senha" class="w-full mb-4 p-2 border rounded text-sm text-center">
                    <input type="password" id="manager-password" placeholder="Insira a senha de coordenador" class="w-full mb-4 p-2 border rounded text-sm text-center">
                    
                    <button onclick="fazerCadastro()" class="w-full bg-orange-500 text-white p-2 rounded hover:bg-orange-600 transition font-bold mb-4">Finalizar Cadastro</button>
                    
                    <p class="text-xs text-gray-500">J√° tem conta? 
                        <a href="javascript:void(0)" onclick="alternarTelas('register-manager-section', 'login-section')" class="text-blue-600 hover:underline">Voltar ao Login</a>
                    </p>
                </div>                

                <div id="user-section" class="hidden mt-4">
                    <h2 class="text-lg font-bold mb-4 text-blue-600 border-b pb-2">Nova Reserva</h2>
                    
                    <h2 class="font-semibold mb-1 text-gray-500 text-xs uppercase">COORDENADOR</h2>
                    <select id="coordenador" class="w-full mb-2 p-2 border rounded text-sm text-gray-800">
                        <option value="" disabled selected hidden>Selecione o coordenador respons√°vel</option>
                        
                        <option value="Gabriel Santos Meyer" class="text-gray-800">Gabriel Santos Meyer</option>
                        <option value="Rog√©rio Santos de Oliveira" class="text-gray-800">Rog√©rio Santos de Oliveira</option>
                    </select>

                    <h2 class="font-semibold mb-1 text-gray-500 text-xs uppercase">Solicitantes</h2>
                    <input type="text" id="solicitantes" placeholder="Pessoa 1/Pessoa 2" class="w-full mb-3 p-2 border rounded text-sm">
                    
                    <h2 class="font-semibold mb-1 text-gray-500 text-xs uppercase">Atividade</h2>
                    <textarea id="atividade" placeholder="Detalhamento da atividade..." rows="3" class="w-full mb-3 p-2 border rounded text-sm"></textarea>
                    
                    <h2 class="font-semibold mb-1 text-gray-500 text-xs uppercase">Data inicial</h2>
                    <input type="datetime-local" id="reserva-inicial" class="w-full mb-3 p-2 border rounded text-sm">
                    
                    <h2 class="font-semibold mb-1 text-gray-500 text-xs uppercase">Data final</h2>
                    <input type="datetime-local" id="reserva-final" class="w-full mb-4 p-2 border rounded text-sm">
                    
                    <button onclick="solicitarAgendamento()" class="w-full bg-green-500 text-white p-2 rounded font-bold hover:bg-green-600 transition">Solicitar Reserva</button>
                </div>
            </div>
        </div>

        <div class="w-full lg:w-2/4">
            <div id="calendar-container" class="bg-white p-6 rounded-lg shadow-lg hidden">
                <h2 class="text-xl font-bold mb-4 text-gray-700 flex items-center gap-2">
                    <span>üìÖ</span> Agenda de Reservas
                </h2>
                <div id="calendario"></div>
            </div>
            

        </div>

        <div class="w-full lg:w-1/4">
            <div id="manager-section" class="hidden bg-white p-6 rounded-lg shadow-lg border-t-4 border-red-500">
                <h2 class="font-bold text-red-600 mb-4 text-lg flex items-center gap-2">
                    <span>üõ°Ô∏è</span> Painel do Gestor
                </h2>
                <div id="lista-pendente" class="text-sm text-gray-600 space-y-2">
                    <p class="italic">Carregando solicita√ß√µes...</p>
                </div>
            </div>
        </div>

    </div>
</body>

    <script>
      


        const COR_PENDENTE = '#f59e0b';
        const COR_PROCESSADO = '#3b82f6';
        const COR_NEGADO = '#cf0a0a';
        const COR_APROVADO = '#11f018';
        const N8N_WEBHOOK_URL = 'https://conta222.app.n8n.cloud/webhook-test/d6bb9b78-47c4-4ad8-9c4f-1fe9c3ea7a14';
        const N8N_HEADER_AUTH = 'l1U9D3w5B##441V8BdJ2n1YVP86jdO9T&4CcB$98';
        const SENHA_ADMIN = 'admin_inframerica';
        let currentUser = null;
        let listaGlobalReservas = [];



        /**
         * Inicializa o calend√°rio com os dados vindos do n8n.
         * @param {Array} reservas - Lista de objetos [{atividade, start, end, color}]
         */
        function inicializarAgenda(reservas) {
            
            // Mostra o container do calend√°rio
            document.getElementById('calendar-container').classList.remove('hidden');
        
            const calendarEl = document.getElementById('calendario');
            const calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                locale: 'pt-br',
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth'
                },
                events: reservas, // O n8n deve enviar os dados neste formato
                eventClick: function(info) {
                    const detalhe = info.event.extendedProps.atividade;
                    const cor = info.event.extendedProps.color;
                    alert('\nIn√≠cio: ' + info.event.start.toLocaleString() +
                          '\nFim: ' + info.event.end.toLocaleString() +
                          '\nAtividade: ' + detalhe +
                          '\nStatus: ' + cor);
                }
            });
        
            calendar.render();
        }
        
        //Fun√ß√£o apenas para transformar a data 2026-02-15T17:23 em 15/02/2026, 17:23
        function formatarDataBR(dataISO) {
            if (!dataISO) return "Data inv√°lida";
            return new Date(dataISO).toLocaleString('pt-BR', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }
        
//----------------------------------------------------------------------------------------------------------


        async function fazerLogin() {
            const email_login = document.getElementById('email').value;
            const senha_login = document.getElementById('senha').value;
        
            if (!email_login || !senha_login) {
                alert("Por favor, preencha todos os campos.");
                return;
            }
            //Dados para mandar para o n8n
            const payload = {
                email: email_login,
                senha: senha_login,
                action: 'login'
            };
        
            try {
                const response = await fetch(N8N_WEBHOOK_URL, {
                    method: 'POST',
                    headers: {
                      'Content-Type': 'application/json',
                      web_authentication: N8N_HEADER_AUTH
                    },
                    body: JSON.stringify(payload)
                });
        
                if (response.ok) {
                    const resultado = await response.json();
        
                    if (resultado.status === 'sucesso') {
                        // currentUser declarado fora da fun√ß√£o: let currentUser = null;
                        currentUser = { role: resultado.role, nome: resultado.nome, email: resultado.email };
                        listaGlobalReservas = resultado.array_calendar;
                        document.getElementById('login-section').classList.add('hidden');
                        document.getElementById('user-section').classList.remove('hidden');
            
                        if (currentUser.role === 'manager') {
                            document.getElementById('manager-section').classList.remove('hidden');
                            carregarSolicitacoes();
                        }
                        //carregarDadosEAgenda();   
                        inicializarAgenda(listaGlobalReservas);

                    } else {
                      // Mensagem de erro que seria mandada devido √† processos internos no N8N
                        alert("Erro: " + (resultado.mensagem || "Credenciais inv√°lidas")); //N√£o implementado o campo mensagens como resposta no n8n
                    }
                } else {
                    // Erro podendo ser de senha errada do Header Auth
                    alert("Erro no servidor (Status: " + response.status + ")");
                }
            } catch (error) {
                // Captura erros de conex√£o (n8n offline, etc)
                alert("N√£o foi poss√≠vel conectar ao servidor do Munck. Verifique sua conex√£o.");
            }
        }       
        
        
        // Fun√ß√£o gen√©rica para trocar visibilidade entre duas se√ß√µes
        function alternarTelas(idSair, idEntrar) {
            document.getElementById(idSair).classList.add('hidden');
            document.getElementById(idEntrar).classList.remove('hidden');
        }
        
        // Fun√ß√£o para enviar o cadastro para o n8n
        async function fazerCadastro() {
            //Checa se est√° na tela de registro de um manager
            const tela_reg_man = document.getElementById('register-section').classList.contains('hidden');
            let nome, senha, email, role;
            
            if(tela_reg_man) {
                const senha_admin = document.getElementById('manager-password').value;
                if(senha_admin != SENHA_ADMIN) { 
                    alert('Insira a senha de admin correta!');
                    return;
                }
                nome = document.getElementById('reg-man-nome').value;
                email = document.getElementById('reg-man-email').value;
                senha = document.getElementById('reg-man-senha').value;
                role = 'manager';
            }
            else {
                nome = document.getElementById('reg-nome').value;
                email = document.getElementById('reg-email').value;
                senha = document.getElementById('reg-senha').value;
                role = 'user';
            }
            if (!nome || !email || !senha) {
                alert("Por favor, preencha todos os campos.");
                return;
            }
        
            const payload = {
                action: 'cadastro',
                nome: nome,
                email: email,
                role: role,
                senha: senha // Trocar para HTTPS posteriormente para seguran√ßa
            };
        
            try {
                const response = await fetch(N8N_WEBHOOK_URL, {
                    method: 'POST',
                    headers: {
                      'Content-Type': 'application/json',
                      web_authentication: N8N_HEADER_AUTH
                    },
                    body: JSON.stringify(payload)
                });
        
                if (response.ok) {
                    alert("Cadastro realizado com sucesso! Agora voc√™ pode fazer login.");
                    if (role === 'manager') alternarTelas('register-manager-section', 'login-section');
                    if (role === 'user') alternarTelas('register-section', 'login-section');
                } else {
                    // Erro podendo ser de senha errada do Header Auth
                    alert("Erro no servidor (Status: " + response.status + ")");
                }
            } catch (error) {
                // Erro podendo ser de senha errada do Header Auth
                alert("N√£o foi poss√≠vel conectar ao servidor do Munck. Verifique sua conex√£o.");
            }
        }
        
//----------------------------------------------------------------------------------------------------------
        

        async function solicitarAgendamento() {
            const inicio = document.getElementById('reserva-inicial').value;
            const fim = document.getElementById('reserva-final').value;
            const atividade = document.getElementById('atividade').value;
            const solicitantes = document.getElementById('solicitantes').value;
            const coordenador = document.getElementById('coordenador').value;

            const payload = {
                action: 'agendamento',
                nome: currentUser.nome,
                user: currentUser.email,
                data_inicio: inicio,
                data_fim: fim,
                atividade: atividade,
                solicitantes: solicitantes,
                coordenador: coordenador
            };
            
            if(!atividade || !inicio || !fim || !solicitantes || !coordenador){
              alert("Por favor, preencha todos os campos.");
              return;
            }

            try {
                const response = await fetch(N8N_WEBHOOK_URL, {
                    method: 'POST',
                    headers: {
                      'Content-Type': 'application/json',
                      web_authentication: N8N_HEADER_AUTH
                    },
                    body: JSON.stringify(payload)
                });
        
                if (response.ok) {
                    const resultado = await response.json();
                    
                    //Atualizando lista e renderizando novamente calendario
                    listaGlobalReservas.push(resultado);
                    inicializarAgenda(listaGlobalReservas);

                    
                    alert(`Solicita√ß√£o enviada!\n ID da solicita√ß√£o:  ${resultado.id}`);
                } else {
                    // Erro podendo ser de senha errada do Header Auth
                    alert("Erro no servidor (Status: " + response.status + ")");
                }
            } catch (error) {
                // Erro podendo ser de senha errada do Header Auth
                alert("N√£o foi poss√≠vel conectar ao servidor do Munck. Verifique sua conex√£o.");
            }
        }

        async function carregarSolicitacoes() {
            //lista com cada div de pend√™ncia
            const listaContainer = document.getElementById('lista-pendente');
            
            //lista com cada pend√™ncia em formato json
            const listaPendentes = listaGlobalReservas.filter(item => {
                    return item.color === COR_PENDENTE;
                });
                
        
            // Limpa o container antes de carregar
            listaContainer.innerHTML = "";
        
            if (listaPendentes.length === 0) {
                listaContainer.innerHTML = "<p class='italic text-gray-400'>Nenhuma pend√™ncia no momento.</p>";
                return;
            }
        
            // Cria o HTML para cada pedido
            listaPendentes.forEach(pedido => {
                const card = document.createElement('div');
                card.className = "bg-gray-50 p-3 border rounded-md shadow-sm border-l-4 border-orange-400 mb-3";
                card.id = `card-pedido-${pedido.id}`; // ID √∫nico para remover depois
        
                card.innerHTML = `
                   <div class="flex justify-between gap-2">
                      <span class="font-bold text-gray-800">
                          ${pedido.nome} </span>
                      <span class="text-[11px] text-gray-900 font-medium">
                          Pedido feito dia ${formatarDataBR(pedido.createdAt).split(',')[0]} </span>
                      <span class="text-[10px] bg-orange-100 text-orange-600 px-1 rounded font-bold">
                          PENDENTE
                      </span>
                    </div>
                    <p class="text-xs text-gray-600 mb-2">Atividade: ${pedido.atividade}</p>
                    <p class="text-xs text-gray-600 mb-2">Solicitantes: ${pedido.solicitantes}</p>
                    <p class="text-xs text-gray-600 mb-2">Coordenador respons√°vel: ${pedido.coordenador}</p>
                    <div class="text-[10px] text-gray-500 mb-3">
                        <p>üìÖ Inicio:  ${formatarDataBR(pedido.start)}</p>
                        <p>üèÅ Fim:     ${formatarDataBR(pedido.end)}</p>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="decidirPedido(${pedido.id}, 'aprovado')" 
                            class="flex-1 bg-green-500 text-white py-1 rounded text-xs hover:bg-green-600 transition">
                            ‚úÖ Aprovar
                        </button>
                        <button onclick="decidirPedido(${pedido.id}, 'negado')" 
                            class="flex-1 bg-red-100 text-red-600 py-1 rounded text-xs hover:bg-red-200 transition">
                            ‚ùå Negar
                        </button>
                    </div>
                `;
                listaContainer.appendChild(card);
            });
        }
        
        async function decidirPedido(idPedido, acao) {


            try{
                const response = await fetch(N8N_WEBHOOK_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', web_authentication: N8N_HEADER_AUTH },
                    body: JSON.stringify({ action: 'decisao_gestor', id: idPedido, status: acao })
                });
                if (!response.ok) {
                    alert("Erro no servidor (Status: " + response.status + ")");
                    return;
                }
            } catch (error) {
                // Erro podendo ser de senha errada do Header Auth
                alert("N√£o foi poss√≠vel conectar ao servidor do Munck. Verifique sua conex√£o.");
                return;
            }
            
            console.log(`Pedido ${idPedido} foi ${acao}`);
            // Simula√ß√£o visual: Remove o card da tela com um efeito simples
            const card = document.getElementById(`card-pedido-${idPedido}`);
            card.classList.add('opacity-50', 'pointer-events-none');
            
            setTimeout(() => {
                card.remove();
                alert(`Solicita√ß√£o ${idPedido} marcada como: ${acao.toUpperCase()}`);
                
                // Se n√£o sobrar nenhum card, mostra a mensagem de vazio
                const lista = document.getElementById('lista-pendente');
                if (lista.children.length === 0) {
                    lista.innerHTML = "<p class='italic text-gray-400'>Nenhuma pend√™ncia no momento.</p>";
                }
            }, 500);
        }
    </script>
</body>
</html>
